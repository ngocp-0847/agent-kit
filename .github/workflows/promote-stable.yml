name: Promote to Stable Release

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (no actual release)"
        required: false
        type: boolean
        default: false
      skip_npm_publish:
        description: "Skip npm publish"
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  id-token: write

jobs:
  validate:
    name: Validate Pre-release
    runs-on: ubuntu-latest
    outputs:
      current_version: ${{ steps.version.outputs.current }}
      stable_version: ${{ steps.version.outputs.stable }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get current version
        id: version
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          
          # Check if it's a pre-release version (contains -)
          if [[ "$CURRENT_VERSION" == *"-"* ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            # Extract stable version (everything before the -)
            STABLE_VERSION=$(echo "$CURRENT_VERSION" | cut -d'-' -f1)
            echo "stable=$STABLE_VERSION" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "stable=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Validate pre-release
        if: steps.version.outputs.is_prerelease != 'true'
        run: |
          echo "âŒ Current version (${{ steps.version.outputs.current }}) is not a pre-release."
          echo "Pre-release versions must contain a hyphen (e.g., 1.0.2-beta.1)"
          exit 1

      - name: Check if stable tag exists
        run: |
          STABLE_TAG="v${{ steps.version.outputs.stable }}"
          if git rev-parse "$STABLE_TAG" >/dev/null 2>&1; then
            echo "âŒ Tag $STABLE_TAG already exists!"
            exit 1
          fi
          echo "âœ… Tag $STABLE_TAG is available"

      - name: Summary
        run: |
          echo "## ðŸ“¦ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Current Version | \`${{ steps.version.outputs.current }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Stable Version | \`${{ steps.version.outputs.stable }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Dry Run | ${{ inputs.dry_run }} |" >> $GITHUB_STEP_SUMMARY

  promote:
    name: Promote to Stable
    needs: validate
    if: needs.validate.outputs.is_prerelease == 'true'
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update package.json version
        run: |
          npm version ${{ needs.validate.outputs.stable_version }} --no-git-tag-version
          echo "âœ… Updated package.json to ${{ needs.validate.outputs.stable_version }}"

      - name: Update release-please manifest
        run: |
          echo '{ ".": "${{ needs.validate.outputs.stable_version }}" }' > .release-please-manifest.json
          echo "âœ… Updated .release-please-manifest.json"

      - name: Update release-please config for stable
        run: |
          # Disable prerelease mode for stable release
          node -e "
            const fs = require('fs');
            const config = JSON.parse(fs.readFileSync('release-please-config.json', 'utf8'));
            config.packages['.'].prerelease = false;
            delete config.packages['.']['prerelease-type'];
            fs.writeFileSync('release-please-config.json', JSON.stringify(config, null, 2) + '\n');
          "
          echo "âœ… Disabled prerelease mode in release-please-config.json"

      - name: Generate changelog entry
        id: changelog
        run: |
          STABLE_VERSION="${{ needs.validate.outputs.stable_version }}"
          CURRENT_VERSION="${{ needs.validate.outputs.current_version }}"
          
          # Get the previous stable tag
          PREV_TAG=$(git tag -l "v*" --sort=-v:refname | grep -v "-" | head -n1)
          
          # Generate changelog content
          CHANGELOG_CONTENT="## What's Changed\n\n"
          CHANGELOG_CONTENT+="This release promotes \`$CURRENT_VERSION\` to stable.\n\n"
          
          if [[ -n "$PREV_TAG" ]]; then
            CHANGELOG_CONTENT+="### Changes since $PREV_TAG\n\n"
            COMMITS=$(git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges 2>/dev/null || echo "")
            if [[ -n "$COMMITS" ]]; then
              CHANGELOG_CONTENT+="$COMMITS"
            fi
          fi
          
          # Save to file for release body
          echo -e "$CHANGELOG_CONTENT" > /tmp/release_notes.md
          echo "Generated release notes"

      - name: Commit changes
        if: inputs.dry_run != true
        run: |
          git add package.json .release-please-manifest.json release-please-config.json
          git commit -m "chore(release): promote ${{ needs.validate.outputs.current_version }} to stable ${{ needs.validate.outputs.stable_version }}"
          git push

      - name: Create and push tag
        if: inputs.dry_run != true
        id: release
        run: |
          TAG_NAME="v${{ needs.validate.outputs.stable_version }}"
          git tag -a "$TAG_NAME" -m "Release $TAG_NAME"
          git push origin "$TAG_NAME"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "âœ… Created and pushed tag $TAG_NAME"

      - name: Create GitHub Release
        if: inputs.dry_run != true
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.validate.outputs.stable_version }}
          name: v${{ needs.validate.outputs.stable_version }}
          body_path: /tmp/release_notes.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Dry run summary
        if: inputs.dry_run == true
        run: |
          echo "## ðŸ§ª Dry Run Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Would have:" >> $GITHUB_STEP_SUMMARY
          echo "- Updated package.json to \`${{ needs.validate.outputs.stable_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Updated .release-please-manifest.json" >> $GITHUB_STEP_SUMMARY
          echo "- Disabled prerelease mode in release-please-config.json" >> $GITHUB_STEP_SUMMARY
          echo "- Created tag \`v${{ needs.validate.outputs.stable_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Created GitHub release" >> $GITHUB_STEP_SUMMARY

  publish:
    name: Publish to npm
    needs: [validate, promote]
    if: inputs.dry_run != true && inputs.skip_npm_publish != true
    uses: ./.github/workflows/publish.yml
    with:
      tag: latest
    secrets:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

